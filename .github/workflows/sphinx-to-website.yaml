---
  name: Generate Sphinx Docs and Commit to Website
  on:
      push:
          branches: # This needs to be changed to a time 
              # - stable
              - sphinx-tester
  jobs:
      build-sphinx:
          permissions:
              contents: write
  
          runs-on: ubuntu-latest
          container: ghcr.io/gem5/ubuntu-24.04_all-dependencies:latest
          steps:
              - name: checkout gem5
                uses: actions/checkout@v4
                with:
                    repository: erin-le/gem5
                    path: gem5
                    ref: sphinx-website

              - name: checkout website
                uses: actions/checkout@v4
                with:
                    path: website
                    ref: stable
              - name: install Sphinx
                run: |
                    apt-get update
                    apt-get install python3-sphinx -y --fix-missing
                    sphinx-build --version
  
              - name: Cache gem5 # remove caching in final
                id: cache-gem5
                uses: actions/cache@v4
                with:
                    path: gem5/build/ALL
                    key: gem5.opt
              - name: Build gem5
                if: steps.cache-gem5.outputs.cache-hit != 'true'
                # The entire build/ALL folder is cached, so try commenting this
                # out to see if gem5 will build relatively quickly
                run: |
                  cd gem5
                  scons build/ALL/gem5.opt -j $(nproc)
              - name: Generate RST
                run: |
                    cd gem5/docs
                    pwd
                    ../build/ALL/gem5.opt gem5-sphinx-apidoc -o . ../src/python/gem5 -F -e
  
              - name: Generate Sphinx docs
                run: |
                    pwd
                    ls
                    cd gem5/docs
                    pwd
                    ../build/ALL/gem5.opt gem5-sphinx -M html . _build
              - name: Add frontmatter
                run: |
                    rm -r website/_pages/documentation/general_docs/sphinx_docs
                    mkdir website/_pages/documentation/general_docs/sphinx_docs
                    cp -r gem5/docs/_build/html/* website/_pages/documentation/general_docs/sphinx_docs
                    cd website
                    cat add-sphinx-docs.py
                    ls
                    python3 add-sphinx-docs.py
              - name: Commit documentation changes to gem5/website repo
                continue-on-error: true
                run: |
                    # git config --global --add safe.directory "$GITHUB_WORKSPACE"
                    pwd
                    # Note: the following account information will not work on GHES
                    cat website/add-sphinx-docs.py
                    cd website
                    cat _pages/documentation/general_docs/sphinx_docs/_modules/index.html
                    # git switch sphinx-docs
                    pwd
                    git branch
                    git config user.name "github-actions[bot]"
                    git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                    git add .
                    git commit -m "Update Sphinx documentation" -a || true
                    git push